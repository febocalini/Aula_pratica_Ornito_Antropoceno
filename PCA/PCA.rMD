
---
title: "PCA – Dados de SNPs"
author: "F. Bocalini"
date: "Agosto 2025"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```

# 1. Preparação

```{r pacotes}
# Carregar pacotes
library(adegenet)
library(vcfR)
library(tidyr)
library(tibble)
library(tidyverse)
library(ggrepel)
```

```{r diretorio}
# Definir diretório de trabalho
setwd("C:/Users/Fernanda Bocalini/Dropbox/pos-doc/aula_ornito_antropoceno/aula_pratica/PCA")
```

# 2. Leitura e transformação dos dados

```{r leitura}
# Ler o arquivo VCF
my_vcf <- read.vcfR("xipho_95_total_final.vcf.gz")

# Transformar VCF em genind
my_genind <- vcfR2genind(my_vcf)
class(my_genind) # checar transformação

# Checar algumas linhas da matriz de genótipos
tab(my_genind)[1:5,1:10]

# Alelos por locus
my_genind@all.names %>% head

# Fator de loci
locFac(my_genind) %>% head

# Nomes dos indivíduos
ind_names <- indNames(my_genind)
ind_names
write.csv(ind_names, file="ind_names.csv") # salvar nomes (ordem importa)
```

# 3. Estatísticas básicas

```{r estatisticas}
# Verificar ploidia
ploidy(my_genind)

# Número de loci e indivíduos
nLoc(my_genind)
nInd(my_genind)

# Definir populações
indmap <- read.table("popmap_xipho.csv", sep=",", colClasses="character", header=TRUE)
pop(my_genind) <- indmap[,"pop"]
pop(my_genind) # checar populações
seppop(my_genind) # estatísticas por população
```

# 4. PCA

```{r pca}
# Extrair frequências alélicas e substituir NA pela média
allele_freq <- tab(my_genind, freq = TRUE, NA.method = "mean")

# Realizar PCA
my_pca <- dudi.pca(allele_freq, scale = FALSE, scannf = FALSE, nf = 10)

# Plot eigenvalues
barplot(my_pca$eig, main="PCA eigenvalues")
barplot(my_pca$eig[1:5], main="PCA eigenvalues")

# Proporção de variância explicada
eig_perc <- my_pca$eig / sum(my_pca$eig)

# Preparar data frame para ggplot
my_pca_df <- data.frame(
  individual = row.names(my_pca$li),
  PC1 = my_pca$li[,1],
  PC2 = my_pca$li[,2],
  PC3 = my_pca$li[,3],
  population = pop(my_genind)
)

# Definir cores das populações
col <- c(AF="#08bdbd", AM="#29bf12", Ceara="#ff9914", PCE="#f21b3f")
```

# 5. PCA Base R

```{r pca_baseR}
pops <- pop(my_genind)
l_pop <- levels(pops)
par(xpd=TRUE)
s.class(my_pca$li, factor(pops,levels=l_pop),
        xax=1, yax=2, col=transp(col,0.7),
        axesell=F, cstar=0, cpoint=2, grid=F, label=NULL, cellipse=T, pch=19)

legend("bottomleft", yjust=1, bty="n", cex=0.6, title="PCA", l_pop, fill=col)
```

# 6. PCA ggplot – PC1 vs PC2

```{r pca_ggplot}
ggplot(data = my_pca_df, aes(x=PC1, y=PC2, color=indmap$pop)) +
  geom_point(size=6, alpha=0.9, stroke=1.2, color="black", aes(fill=indmap$pop), shape=21) +
  scale_fill_manual(values=col) +
  theme_classic() +
  labs(
    x=paste0("PC1 (", round(eig_perc[1]*100,1), "%)"),
    y=paste0("PC2 (", round(eig_perc[2]*100,1), "%)"),
    fill=NULL
  ) +
  theme(
    legend.text=element_text(face="bold", size=14),
    axis.text=element_text(face="bold", size=16),
    axis.title=element_text(face="bold", size=18)
  )
```

# 7. PCA ggplot – PC2 vs PC3

```{r pca_ggplot_PC23}
ggplot(data = my_pca_df, aes(x=PC2, y=PC3, color=indmap$pop)) +
  geom_point(size=6, alpha=0.9, stroke=1.2, color="black", aes(fill=indmap$pop), shape=21) +
  scale_fill_manual(values=col) +
  theme_classic() +
  labs(
    x=paste0("PC2 (", round(eig_perc[2]*100,1), "%)"),
    y=paste0("PC3 (", round(eig_perc[3]*100,1), "%)"),
    fill=NULL
  ) +
  theme(
    legend.text=element_text(face="bold.italic", size=14),
    axis.text=element_text(face="bold", size=16),
    axis.title=element_text(face="bold", size=18)
  )
```

# 8. PCA com rótulos das amostras

```{r pca_labels}
x_range <- range(my_pca_df$PC1)
y_range <- range(my_pca_df$PC2)
x_padding <- 0.1 * diff(x_range)
y_padding <- 0.1 * diff(y_range)

ggplot(my_pca_df, aes(x=PC1, y=PC2, fill=indmap$pop)) +
  geom_point(size=6, alpha=0.9, stroke=1.2, color="black", shape=21) +
  geom_text_repel(
    aes(label=indmap$id),
    size=1.5, color="black",
    box.padding=0.5, max.overlaps=Inf
  ) +
  scale_fill_manual(values=col) +
  theme_classic() +
  labs(
    x=paste0("PC1 (", round(eig_perc[1]*100,1), "%)"),
    y=paste0("PC2 (", round(eig_perc[2]*100,1), "%)"),
    fill=NULL
  ) +
  coord_cartesian(
    xlim=range(my_pca_df$PC1)*1.1,
    ylim=range(my_pca_df$PC2)*1.1
  )
```

###### FIM ######
